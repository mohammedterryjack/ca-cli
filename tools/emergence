#!/usr/bin/env python3

from collections import Counter 
from pathlib import Path 

import click
from numpy import array, asarray, arange, full, full_like, isnan, nan, nan_to_num, any as np_any
from PIL import Image
from pyfiglet import Figlet

from utils import render_halfblock, save_evolution

f = Figlet(font="smslant")
banner = f.renderText("Emergence")

def delay_embedding_density(
    sequence:list[int], 
    time_delay:int, 
    embedding_dimension:int, 
    normalise:bool
) -> list[float]:
    sequence = asarray(sequence)
    N = len(sequence)
    start = (embedding_dimension - 1) * time_delay
    if N <= start:
        return full(N, nan)

    embedded = array([
        tuple(sequence[i - arange(embedding_dimension) * time_delay])
        for i in range(start, N)
    ])

    counts = Counter(map(tuple, embedded))
    densities = full(N, nan)
    for idx, vec in enumerate(embedded, start=start):
        densities[idx] = counts[tuple(vec)]

    if normalise:
        valid = ~isnan(densities)
        if np_any(valid):
            vals = densities[valid]
            densities[valid] = (vals - vals.min()) / (vals.max() - vals.min() + 1e-12)

    return densities


def filter_spacetime_by_delay_embedding_density(
    spacetime:list[list[int]], 
    time_delay:int,
    embedding_dimension:int,
    normalise:bool=True
) -> list[list[float]]:
    data = asarray(spacetime)
    n_rows, n_cols = data.shape
    rareness_matrix = full_like(data, nan, dtype=float)

    for i in range(n_rows):
        sequence = data[i, :]
        rareness_matrix[i, :] = delay_embedding_density(
          sequence=sequence,
          time_delay=time_delay,
          embedding_dimension=embedding_dimension,
          normalise=normalise
        )

    return rareness_matrix



@click.command(name="emergence")
@click.option('--input', '-i', 'input_path', required=True, type=Path,
              help="Path to input PNG file representing the CA evolution.")
@click.option('--output', '-o', 'output_path', type=Path,
              help="Path to save the output image (default: rareness_output.png).")
@click.option('--threshold', '-th', type=float,
              help="Optional threshold (e.g., 0.3) to binarize the result.")
@click.option('--time-delay', '-tau', type=int, default=1,
              help="Time delay (tau) for delay embedding (default: 1).")
@click.option('--embedding-dimension', '-d', type=int, default=3,
              help="Embedding dimension for delay embedding (default: 3).")
def complexity_cli(input_path:Path, output_path:Path, threshold:float|None, time_delay:int, embedding_dimension:int) -> None:
    
    click.secho(banner, fg="yellow", bold=True) 
    
    if output_path is None:
        output_path = input_path.parent / f"{input_path.stem}_emergence.png"
    img = Image.open(input_path).convert('L')  
    data = array(img)
    if data.max() > 1:
        data = data / 255.0

    click.echo(f"Loaded input: {data.shape} (min={data.min():.3f}, max={data.max():.3f})")
    click.echo(f"Parameters → tau={time_delay}, dim={embedding_dimension}, threshold={threshold}")

    rareness = filter_spacetime_by_delay_embedding_density(
        spacetime=data, 
        time_delay=time_delay, 
        embedding_dimension=embedding_dimension,
    )
    if threshold is not None:
        binary = (rareness >= threshold).astype(int)
        click.echo(f"Applied threshold: {threshold}")
        binary.tolist()
        click.echo(render_halfblock(values=binary))
        rareness = binary

    save_evolution(values=rareness, path=output_path)
    click.echo(f"Saved output image → {output_path}")


if __name__ == "__main__":
    complexity_cli()

